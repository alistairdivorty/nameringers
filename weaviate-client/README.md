## Weaviate Client

- [What It Does](#1-what-it-does)
- [Local Setup](#2-local-setup)
  - [Prerequisites](#21-prerequisites)
  - [Set Up Environment](#22-set-up-environment)
- [Directory Structure](#3-directory-structure)
- [Invoke Lambda Function in Local Development Environment](#4-invoke-lambda-function-in-local-development-environment)
- [Deployment](#5-deployment)
- [Invoke Lambda REST API in Production Environment](#6-invoke-lambda-rest-api-in-production-environment)

### 1. What It Does

This is a [Lambda function](https://aws.amazon.com/lambda/) written in Scala that acts as a web client for the database server. The [Lambda proxy integration type](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-integrations.html) is used to integrate a REST API with the Lambda function. The function handler method translates the query parameters passed via the REST API into a GraphQL query that is submitted to the GraphQL endpoint exposed by the database server. Search queries are transformed into feature vectors using a fitted pipeline generated by the Spark application that is shared via a Lambda layer using the [MLeap serialisation format](https://combust.github.io/mleap-docs/core-concepts/mleap-bundles.html) and run using the [MLeap execution engine](https://combust.github.io/mleap-docs/core-concepts/mleap-runtime.html).

### 2. Local Setup

#### 2.1. Prerequisites

- [sbt](https://www.scala-sbt.org/download.html)
- [AWS Serverless Application Model (SAM) CLI](https://aws.amazon.com/serverless/sam/)

#### 2.2. Set Up Environment

The [SAM CLI](https://aws.amazon.com/serverless/sam/) requires access to AWS credentials with permission to pull Lambda layer versions. Access to your credentials can be configured using the [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html) by running `aws configure` and following the prompts.

### 3. Directory Structure

```
ðŸ“¦weaviate-client
 â”£ ðŸ“‚project
 â”£ ðŸ“‚target
 â”£ ðŸ“‚src
 â”ƒ â”£ ðŸ“‚main
 â”ƒ â”ƒ â”£ ðŸ“‚java
 â”ƒ â”ƒ â”— ðŸ“‚scala
 â”ƒ â”ƒ â”ƒ â”— ðŸ“‚client
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œScalaHandler.scala
 â”£ ðŸ“œDockerfile
 â”£ ðŸ“œbuild.sbt
 â”£ ðŸ“œevent.json
 â”— ðŸ“œtemplate.yaml
```

### 4. Invoke Lambda Function in Local Development Environment

To invoke the Lambda function locally using the [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-reference.html#serverless-sam-cli), run `sam local invoke -e event.json` from the `weaviate-client` directory. The ARN for the Lambda layer used to share the serialised Spark model will need to be added to the SAM template file along with a value for the `WEAVIATE_ENDPOINT` environment variable.

### 5. Deployment

The [AWS CDK app](#5-aws-cdk-app) takes care of bundling the project files and dependencies into an assembly jar for deployment to Lambda. The CDK app also creates a new version of the Lambda layer used for sharing the serialised model trained by the Spark application. To deploy the application using the [AWS CDK Toolkit](https://docs.aws.amazon.com/cdk/v2/guide/cli.html), change the current working directory to `cdk` and run `cdk deploy WeaviateClientStack`.

### 6. Invoke Lambda REST API in Production Environment

The following example shows how to invoke the API that routes HTTP requests to the Lambda function that interfaces with the database server.

```shell
curl \
  -X GET \
  -G \
  -d query=test \
  -d distance=0.5 \
  https://<API-ID>.execute-api.eu-west-1.amazonaws.com/prod
```
