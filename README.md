# NameRingers

This monorepo contains a feature extraction pipeline that runs on the Spark data processing framework, a Scala application that acts as a web client for an instance of the Weaviate vector database, a Java application for consuming an API that provides access to zone files for generic top-level domains, a web application for allowing users to perform similarity search across a dataset consisting of newly registered domain names by querying the vector database, and an application for provisioning the required cloud infrastructure.

- [Feature Extraction Pipeline](#1-feature-extraction-pipeline)
- [Weaviate Client](#2-weaviate-client)
- [Zone File Client](#3-zone-file-client)
- [Web App](#4-web-app)
- [AWS CDK App](#5-aws-cdk-app)

## 1. Feature Extraction Pipeline

- [What It Does](#11-what-it-does)
- [Local Setup](#12-local-setup)
  - [Prerequisites](#121-prerequisites)
  - [Set Up Environment](#122-set-up-environment)
- [Directory Structure](#13-directory-structure)
- [Run Job in Local Development Environment](#14-run-job-in-local-development-environment)
- [Deployment](#15-deployment)
- [Run Job in Production Environment](#16-run-job-in-production-environment)

### 1.1. What It Does

This is a feature extraction pipeline written in Scala that uses [Spark's machine learning library](https://spark.apache.org/docs/latest/ml-guide.html) to generate feature vectors for a text corpus consisting of domain names.

### 1.2. Local Setup

#### 1.2.1. Prerequisites

- [OpenJDK 11](https://adoptopenjdk.net/releases.html)
- [sbt](https://www.scala-sbt.org/download.html)
- [Docker](https://www.docker.com/)

#### 1.2.2. Set Up Environment

If your system runs on the Apple Silicon M1 processor, disable fork safety by adding the following line to your shell initialisation file.

```shell
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
```

The [Hadoop-AWS module](https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/index.html) requires access to AWS credentials with permission to write data to S3. Access to your credentials can be configured using the [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html) by running `aws configure` and following the prompts.

To start a local instance of the [Weaviate vector database](https://weaviate.io/) using [Docker Compose](https://docs.docker.com/compose/), paste the Compose specification below into a local `docker-compose.yml` file and run the command `docker-compose up` from the directory containing the YML file. The database server will be reachable at the hostname `localhost:8080`.

```yml
version: "3.4"
services:
  weaviate:
    image: semitechnologies/weaviate:1.14.0
    ports:
      - 8080:8080
    restart: on-failure:0
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      DEFAULT_VECTORIZER_MODULE: "none"
      CLUSTER_HOSTNAME: "node1"
```

### 1.3. Directory Structure

```
ðŸ“¦spark
 â”£ ðŸ“‚lib
 â”ƒ â”— ðŸ“œweaviate-spark-connector-assembly-v0.1.2.jar
 â”£ ðŸ“‚project
 â”£ ðŸ“‚target
 â”£ ðŸ“‚src
 â”ƒ â”£ ðŸ“‚main
 â”ƒ â”ƒ â”— ðŸ“‚scala
 â”ƒ â”ƒ â”ƒ â”— ðŸ“‚spark
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œDomainNames.scala
 â”£ ðŸ“œ.gitignore
 â”£ ðŸ“œDockerfile
 â”— ðŸ“œbuild.sbt
```

### 1.4. Run Job in Local Development Environment

Execute the following command from the `spark` directory to launch a Spark session in standalone mode and run the `DomainNames` job in the same virtual machine as sbt.

```shell
sbt "run <zone-file-uri> <bucket-name> <weaviate-host>"
```

The placeholder values for the script arguments refer to:

- a path to a TXT file generated by the Zone File Client application documented below;
- the name of an S3 bucket for storing the serialised model that can be accessed using AWS credentials configured for your local environment; and
- the hostname for a local or remote instance of the Weaviate vector database.

### 1.5. Deployment

An assembly jar containing the project files and dependencies needs to be uploaded to an S3 bucket from where it can be downloaded by the [EMR Serverless](https://aws.amazon.com/emr/serverless/) application when running in production. The [AWS CDK app](#5-aws-cdk-app) takes care of bundling the source code and uploading the deployment artifact. To deploy the application using the [AWS CDK Toolkit](https://docs.aws.amazon.com/cdk/v2/guide/cli.html), change the current working directory to `cdk` and run `cdk deploy NameRingersEMRServerlessStack`. See the [AWS CDK app](#5-aws-cdk-app) section for details of how to set up the AWS CDK Toolkit. The AWS CDK app outputs the ID of the EMR Serverless application created by the CloudFormation stack, the [ARN](https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html) for the [IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) execution role, and S3 URIs for the assembly jar and logs folder.

### 1.6. Run Job in Production Environment

The following is an example of how to submit a job to the [EMR Serverless](https://docs.aws.amazon.com/emr/latest/EMR-Serverless-UserGuide/emr-serverless.html) application deployed by the [AWS CDK app](#5-aws-cdk-app) using the [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html). The placeholder values should be replaced with the values outputted by the CDK app after deployment of the `NameRingersEMRServerlessStack` and `WeaviateStack` stacks.

```shell
aws emr-serverless start-job-run \
    --region eu-west-1 \
    --application-id <application-ID> \
    --execution-role-arn <role-ARN> \
    --job-driver '{
        "sparkSubmit": {
            "entryPoint": <assembly-jar-URI>,
            "entryPointArguments": [<zone-file-URI>, <bucket-name>, <weaviate-host>],
            "sparkSubmitParameters": "--class com.nameringers.spark.DomainNames --conf spark.executorEnv.JAVA_HOME=/usr/lib/jvm/java-11-openjdk-11.0.16.0.8-1.amzn2.0.1.x86_64 --conf spark.emr-serverless.driverEnv.JAVA_HOME=/usr/lib/jvm/java-11-openjdk-11.0.16.0.8-1.amzn2.0.1.x86_64 --conf spark.dynamicAllocation.enabled=false --conf spark.executor.instances=2 --conf spark.driver.cores=2 --conf spark.executor.cores=2"
        }
    }' \
    --configuration-overrides '{
        "monitoringConfiguration": {
            "s3MonitoringConfiguration": {
                "logUri": <logs-URI>
            }
        }
    }'
```

The `spark.emr-serverless.driverEnv.JAVA_HOME` and `spark.executorEnv.JAVA_HOME` configuration properties refer to an image stored in [ECR](https://aws.amazon.com/ecr/) that is used to package the specific JDK version required by the project. The `spark` directory contains a `Dockerfile` with instructions for building the JDK 11 image.

## 2. Weaviate Client

- [What It Does](#21-what-it-does)
- [Local Setup](#22-local-setup)
  - [Prerequisites](#221-prerequisites)
  - [Set Up Environment](#222-set-up-environment)
- [Directory Structure](#23-directory-structure)
- [Invoke Lambda Function in Local Development Environment](#24-invoke-lambda-function-in-local-development-environment)
- [Deployment](#25-deployment)
- [Invoke Lambda REST API in Production Environment](#26-invoke-lambda-rest-api-in-production-environment)

### 2.1. What It Does

This is a [Lambda function](https://aws.amazon.com/lambda/) written in Scala that acts as a web client for the database server. The [Lambda proxy integration type](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-integrations.html) is used to integrate a REST API with the Lambda function. The function handler method translates the query parameters passed via the REST API into a GraphQL query that is submitted to the GraphQL endpoint exposed by the database server. Search queries are transformed into feature vectors using a fitted pipeline generated by the Spark application that is shared via a Lambda layer using the [MLeap serialisation format](https://combust.github.io/mleap-docs/core-concepts/mleap-bundles.html) and run using the [MLeap execution engine](https://combust.github.io/mleap-docs/core-concepts/mleap-runtime.html).

### 2.2. Local Setup

#### 2.2.1. Prerequisites

- [sbt](https://www.scala-sbt.org/download.html)
- [AWS Serverless Application Model (SAM) CLI](https://aws.amazon.com/serverless/sam/)

#### 2.2.2. Set Up Environment

The [SAM CLI](https://aws.amazon.com/serverless/sam/) requires access to AWS credentials with permission to pull Lambda layer versions. Access to your credentials can be configured using the [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html) by running `aws configure` and following the prompts.

### 2.3. Directory Structure

```
ðŸ“¦weaviate-client
 â”£ ðŸ“‚project
 â”£ ðŸ“‚target
 â”£ ðŸ“‚src
 â”ƒ â”£ ðŸ“‚main
 â”ƒ â”ƒ â”£ ðŸ“‚java
 â”ƒ â”ƒ â”— ðŸ“‚scala
 â”ƒ â”ƒ â”ƒ â”— ðŸ“‚client
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œScalaHandler.scala
 â”£ ðŸ“œDockerfile
 â”£ ðŸ“œbuild.sbt
 â”£ ðŸ“œevent.json
 â”— ðŸ“œtemplate.yaml
```

### 2.4. Invoke Lambda Function in Local Development Environment

To invoke the Lambda function locally using the [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-reference.html#serverless-sam-cli), run `sam local invoke -e event.json` from the `weaviate-client` directory. The ARN for the Lambda layer used to share the serialised Spark model will need to be added to the SAM template file along with a value for the `WEAVIATE_ENDPOINT` environment variable.

### 2.5. Deployment

The [AWS CDK app](#5-aws-cdk-app) takes care of bundling the project files and dependencies into an assembly jar for deployment to Lambda. The CDK app also creates a new version of the Lambda layer used for sharing the serialised model trained by the Spark application. To deploy the application using the [AWS CDK Toolkit](https://docs.aws.amazon.com/cdk/v2/guide/cli.html), change the current working directory to `cdk` and run `cdk deploy WeaviateClientStack`.

### 2.6. Invoke Lambda REST API in Production Environment

The following example shows how to invoke the API that routes HTTP requests to the Lambda function that interfaces with the database server.

```shell
curl \
  -X GET \
  -G \
  -d query=test \
  -d distance=0.5 \
  https://<API-ID>.execute-api.eu-west-1.amazonaws.com/prod
```

## 3. Zone File Client

- [What It Does](#31-what-it-does)
- [Local Setup](#32-local-setup)
  - [Prerequisites](#321-prerequisites)
- [Directory Structure](#33-directory-structure)
- [Deployment](#34-deployment)
- [Invoke Lambda Function in Production Environment](#35-invoke-lambda-function-in-production-environment)

### 3.1. What It Does

This is a Lambda function written in Java that fetches compressed TXT files containing domain names extracted from the zone files for generic top-level domains, decompresses the data and uploads them to an S3 bucket for retrieval by the feature extraction pipeline. To ensure that the Lambda memory limit is not exceeded as a result of decompressing large files, data are written to an EFS volume mounted onto the function rather than the ephemeral Lambda file system.

### 3.2. Local Setup

#### 3.2.1. Prerequisites

- [OpenJDK 11](https://adoptopenjdk.net/releases.html)
- [Apache Maven](https://maven.apache.org/index.html)

### 3.3. Directory Structure

```
ðŸ“¦zonefile-client
 â”£ ðŸ“‚src
 â”ƒ â”£ ðŸ“‚main
 â”ƒ â”ƒ â”— ðŸ“‚java
 â”ƒ â”ƒ â”ƒ â”— ðŸ“‚com
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“‚nameringers
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“‚zonefile
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œApp.java
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œDependencyFactory.java
 â”£ ðŸ“‚target
 â”£ ðŸ“œ.gitignore
 â”£ ðŸ“œpom.xml
 â”— ðŸ“œtemplate.yaml
```

### 3.4. Deployment

The [AWS CDK app](#5-aws-cdk-app) takes care of bundling the project files and dependencies into an assembly jar for deployment to Lambda. To deploy the application using the [AWS CDK Toolkit](https://docs.aws.amazon.com/cdk/v2/guide/cli.html), change the current working directory to `cdk` and run `cdk deploy ZoneFileStack`.

### 3.5. Invoke Lambda Function in Production Environment

The following example shows how to invoke the Lambda function using the AWS CLI. The function output will be saved to a file named `response.json`.

```shell
aws lambda invoke \
  --function-name <function-name> \
  --payload '{ "zone": "com" }' \
  response.json
```

## 4. Web App

- [What It Does](#41-what-it-does)
- [Local Setup](#42-local-setup)
  - [Prerequisites](#421-prerequisites)
  - [Set Up Environment](#422-set-up-environment)
- [Directory Structure](#43-directory-structure)
- [Deployment](#44-deployment)

### 4.1. What It Does

This is a React-based web application architected with the [Next.js](https://nextjs.org/) framework that allows users to perform similarity search across a dataset consisting of newly registered domain names by querying an index of vectors stored in an instance of the Weaviate vector database.

### 4.2. Local Setup

#### 4.2.1. Prerequisites

- [Node.js JavaScript runtime environment](https://nodejs.org/en/download/)

#### 4.2.2. Set Up Environment

Install the Node dependencies by running `npm install` from the `web-app` directory. Run `npm run dev` to start the local development server. By default the server is started on port 3000. Navigate to `http://localhost:3000` to view the site in a web browser.

To create a file for storing environment variables used by the CDK application during deployment of the web application, change the current working directory to `web-app/cdk` and run `cp .env.example .env`.

### 4.3. Directory Structure

```
ðŸ“¦web-app
 â”£ ðŸ“‚cdk
 â”ƒ â”£ ðŸ“‚bin
 â”ƒ â”ƒ â”— ðŸ“œcdk.ts
 â”ƒ â”£ ðŸ“‚lib
 â”ƒ â”ƒ â”— ðŸ“œweb-app-stack.ts
 â”ƒ â”£ ðŸ“œ.env.example
 â”ƒ â”£ ðŸ“œ.eslintrc.json
 â”ƒ â”£ ðŸ“œ.gitignore
 â”ƒ â”£ ðŸ“œ.npmignore
 â”ƒ â”£ ðŸ“œ.prettierrc
 â”ƒ â”£ ðŸ“œcdk.context.json
 â”ƒ â”£ ðŸ“œcdk.json
 â”ƒ â”£ ðŸ“œjest.config.js
 â”ƒ â”£ ðŸ“œpackage-lock.json
 â”ƒ â”£ ðŸ“œpackage.json
 â”ƒ â”— ðŸ“œtsconfig.json
 â”£ ðŸ“‚nexjs-app
 â”ƒ â”£ ðŸ“‚components
 â”ƒ â”£ ðŸ“‚context
 â”ƒ â”£ ðŸ“‚hooks
 â”ƒ â”£ ðŸ“‚pages
 â”ƒ â”ƒ â”£ ðŸ“œ_app.tsx
 â”ƒ â”ƒ â”£ ðŸ“œ_document.tsx
 â”ƒ â”ƒ â”— ðŸ“œindex.tsx
 â”ƒ â”£ ðŸ“‚public
 â”ƒ â”ƒ â”£ ðŸ“œfavicon.ico
 â”ƒ â”ƒ â”— ðŸ“œrobots.txt
 â”ƒ â”£ ðŸ“‚styles
 â”ƒ â”ƒ â”— ðŸ“œglobals.css
 â”ƒ â”£ ðŸ“‚types
 â”ƒ â”ƒ â”— ðŸ“œindex.ts
 â”ƒ â”£ ðŸ“œ.eslintrc.json
 â”ƒ â”£ ðŸ“œ.gitignore
 â”ƒ â”£ ðŸ“œ.prettierrc.json
 â”ƒ â”£ ðŸ“œnext-env.d.ts
 â”ƒ â”£ ðŸ“œnext.config.js
 â”ƒ â”£ ðŸ“œpackage-lock.json
 â”ƒ â”£ ðŸ“œpackage.json
 â”ƒ â”£ ðŸ“œpostcss.config.js
 â”ƒ â”£ ðŸ“œtailwind.config.js
 â”ƒ â”— ðŸ“œtsconfig.json
```

## 4.4. Deployment

The project is deployed via an AWS CDK application located in the `web-app/cdk` directory. The CDK app takes care of bundling the project files using the [standalone output](https://nextjs.org/docs/advanced-features/output-file-tracing) build mode for deployment to Lambda. To deploy the application using the [AWS CDK Toolkit](https://docs.aws.amazon.com/cdk/v2/guide/cli.html), change the current working directory to `web-app/cdk` and run `cdk deploy NameRingersWebFrontendStack`.

## 5. AWS CDK App

- [What It Does](#51-what-it-does)
- [Local Setup](#52-local-setup)
  - [Prerequisites](#521-prerequisites)
  - [Set Up Environment](#522-set-up-environment)
- [Directory Structure](#53-directory-structure)
- [Deployment](#54-deployment)

### 5.1. What It Does

The [AWS Cloud Development Kit (CDK)](https://docs.aws.amazon.com/cdk/v2/guide/home.html) is a framework for defining cloud infrastructure in code and provisioning it through [AWS CloudFormation](https://aws.amazon.com/cloudformation/). This is an AWS CDK application that defines the cloud infrastructure required by the services contained in this repository.

### 5.2. Local Setup

#### 5.2.1. Prerequisites

- [Node.js JavaScript runtime environment](https://nodejs.org/en/download/)

#### 5.2.2. Set Up Environment

To install the [CDK Toolkit](https://docs.aws.amazon.com/cdk/v2/guide/cli.html) (a CLI tool for interacting with a CDK app) using the [Node Package Manager](https://www.npmjs.com/), run the command `npm install -g aws-cdk`. The CDK Toolkit needs access to AWS credentials. Access to your credentials can be configured using the [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html) by running `aws configure` and following the prompts.

Install the Node dependencies by running `npm install` from the `cdk` directory.

To create a file for storing environment variables, run `cp .env.example .env`.

### 5.3. Directory Structure

```
ðŸ“¦cdk
 â”£ ðŸ“‚src
 â”ƒ â”£ ðŸ“‚main
 â”ƒ â”ƒ â”— ðŸ“‚java
 â”ƒ â”ƒ â”ƒ â”— ðŸ“‚com
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“‚nameringers
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œCdkApp.java
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œEMRServerlessStack.java
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œWeaviateClientStack.java
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œWeaviateFileSystemStack.java
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œWeaviateStack.java
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œZoneFileStack.java
 â”£ ðŸ“‚target
 â”£ ðŸ“œ.env.example
 â”£ ðŸ“œ.gitignore
 â”£ ðŸ“œcdk.context.json
 â”£ ðŸ“œcdk.json
 â”£ ðŸ“œpom.xml
 â”— ðŸ“œweaviate.Dockerfile
```

### 5.4. Deployment

To deploy all the stacks defined by the application, change the current working directory to `cdk` and run `cdk deploy --all`.
